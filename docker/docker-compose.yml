# =============================================================================
# Privacy Router Stack - Docker Compose
# =============================================================================
#
# Experimental Docker deployment for the privacy router stack.
#
# IMPORTANT LIMITATIONS:
# - Requires host networking or macvlan for proper gateway functionality
# - Not as robust as dedicated hardware/VM deployment
# - Kill switch implementation is container-dependent
#
# Usage:
#   1. Copy .env.example to .env and fill in values
#   2. docker-compose up -d
#
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # WireGuard/AmneziaWG VPN Gateway
  # ===========================================================================
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: privacy-router-vpn
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE:-UTC}
    volumes:
      - ./wireguard/config:/config
      - /lib/modules:/lib/modules:ro
    # Use host network for proper gateway functionality
    # Alternative: macvlan network (see below)
    network_mode: host
    # If using bridge network, expose these ports:
    # ports:
    #   - 51820:51820/udp

  # ===========================================================================
  # AdGuard Home DNS Server
  # ===========================================================================
  adguard:
    image: adguard/adguardhome:latest
    container_name: privacy-router-dns
    restart: unless-stopped
    # Use host network to serve DNS on LAN
    network_mode: host
    # If using bridge network:
    # ports:
    #   - 53:53/tcp
    #   - 53:53/udp
    #   - 3000:3000/tcp
    volumes:
      - ./adguard/work:/opt/adguardhome/work
      - ./adguard/conf:/opt/adguardhome/conf
    depends_on:
      - wireguard

# =============================================================================
# ALTERNATIVE: Macvlan Network (for proper LAN integration)
# =============================================================================
# Uncomment and configure if you need containers to have their own LAN IPs
#
# networks:
#   lan:
#     driver: macvlan
#     driver_opts:
#       parent: eth0  # Your LAN interface
#     ipam:
#       config:
#         - subnet: 192.168.1.0/24
#           gateway: 192.168.1.1
#           ip_range: 192.168.1.240/28  # Reserve .240-.254 for containers

# =============================================================================
# Volumes
# =============================================================================
volumes:
  wireguard-config:
  adguard-work:
  adguard-conf:
