#!/bin/sh
# =============================================================================
# AmneziaWG Hotplug Script - Auto-start VPN on WAN Up
# =============================================================================
#
# Automatically starts the VPN tunnel when WAN interface comes up.
# Useful for boot and WAN reconnection scenarios.
#
# Installation:
#   1. Copy to /etc/hotplug.d/iface/99-awg
#   2. chmod +x /etc/hotplug.d/iface/99-awg
#   3. Edit configuration section below
#
# =============================================================================

# =============================================================================
# CONFIGURATION - Edit these values for your setup
# =============================================================================

# Path to AmneziaWG configuration file
CONFIG_FILE="/etc/amneziawg/awg0.conf"

# Your VPN internal IP (assigned by VPN provider)
VPN_IP="CHANGE_ME"

# VPN server endpoint IP
ENDPOINT_IP="CHANGE_ME"

# =============================================================================
# HOTPLUG HANDLER
# =============================================================================

# Only act on WAN interface coming up
# Adjust "wan" if your WAN interface has a different name
[ "$ACTION" = "ifup" ] && [ "$INTERFACE" = "wan" ] && {

    # Brief delay for interface to stabilize
    sleep 2

    # Check if AWG is already up (avoid double-start)
    if ip link show awg0 2>/dev/null | grep -q UP; then
        logger -t awg-hotplug "awg0 already up, skipping"
        exit 0
    fi

    logger -t awg-hotplug "WAN up, starting AmneziaWG tunnel"

    # Remove any stale interface
    ip link del dev awg0 2>/dev/null

    # Create interface
    ip link add dev awg0 type amneziawg
    if [ $? -ne 0 ]; then
        logger -t awg-hotplug "ERROR: Failed to create awg0"
        exit 1
    fi

    # Apply configuration
    /usr/bin/amneziawg setconf awg0 "$CONFIG_FILE"
    if [ $? -ne 0 ]; then
        logger -t awg-hotplug "ERROR: Failed to apply config"
        exit 1
    fi

    # Add address and bring up
    ip address add "$VPN_IP/32" dev awg0
    ip link set up dev awg0

    # Get WAN gateway for endpoint route
    # Try from DHCP-assigned route first
    GATEWAY=$(ip route | grep "default via" | grep -v awg | head -1 | awk '{print $3}')

    # Fallback to common gateway if not available yet
    [ -z "$GATEWAY" ] && GATEWAY="192.168.1.1"

    # Add endpoint route via WAN gateway (prevents routing loop)
    ip route add "$ENDPOINT_IP" via "$GATEWAY" 2>/dev/null

    # Set default route via VPN
    ip route del default 2>/dev/null
    ip route add default dev awg0

    logger -t awg-hotplug "AmneziaWG tunnel started (gateway: $GATEWAY)"
}
